name: .NET Core

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301
    - name: Install dependencies (dotnet)
      run: dotnet restore
    - name: Build Linux
      run: dotnet build --configuration Release --no-restore Indabo.Linux/Indabo.Linux.csproj
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.0.1
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    - name: Install dependencies (msbuild)      
      run: nuget restore Indabo.Windows/packages.config -PackagesDirectory ./packages
    - name: Build Windows
      run: msbuild Indabo.Windows/Indabo.Windows.csproj /p:Configuration=Release
    - name: Commit changes
      run: |
          Write-Output 'Set Version and Date'      
          $INDABOVERSION = (Get-Item ".\Indabo.Windows\bin\Release\Indabo.exe").VersionInfo.FileVersion
          $DATE = get-date
          $DATE = $DATE.toString("yyyy-MM-dd_HH.mm.ss.fff")
          Write-Output 'Setup GIT Repo'      
          git config remote.origin.url https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git fetch --prune --unshallow 
          git checkout Releases
          Write-Output 'Copy Items'
          Copy-Item ./Indabo.Linux/bin/Release/netcoreapp3.1/Indabo.dll -Destination Indabo.dll -Force
          Copy-Item ./Indabo.Linux/bin/Release/netcoreapp3.1/Indabo.dll Indabo_${INDABOVERSION}_${DATE}.dll -Force
          Copy-Item ./Indabo.Windows/bin/Release/Indabo.exe -Destination Indabo.exe -Force
          Copy-Item ./Indabo.Windows/bin/Release/Indabo.exe Indabo_${INDABOVERSION}_${DATE}.exe -Force
          Write-Output 'Adding Items to GIT Repo'
          git add Indabo.dll
          git add Indabo_${INDABOVERSION}_${DATE}.dll
          git add Indabo.exe
          git add Indabo_${INDABOVERSION}_${DATE}.exe
          Write-Output 'Committing'
          git config user.name "github-actions" 
          git config user.email "github-actions@github.com"    
          git commit -am "${INDABOVERSION}_${DATE}"
          git config --unset user.name
          git config --unset user.email
          Write-Output 'Pushing'
          git push
          Write-Output 'Done'